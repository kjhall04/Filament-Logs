<!DOCTYPE html>
<html lang="en" data-theme="{{ app_settings.theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Filament Logs{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --app-bg: #f3f4f6;
            --app-surface: #ffffff;
            --app-text: #111827;
            --app-muted: #6b7280;
            --app-border: #d1d5db;
            --app-striped: #f9fafb;
            --app-accent: #2563eb;
            --app-accent-contrast: #ffffff;

            --bs-body-bg: var(--app-bg);
            --bs-body-color: var(--app-text);
            --bs-secondary-color: var(--app-muted);
            --bs-emphasis-color: var(--app-text);
            --bs-border-color: var(--app-border);
            --bs-tertiary-bg: var(--app-surface);
        }

        html[data-theme="dark"] {
            --app-bg: #0f172a;
            --app-surface: #111827;
            --app-text: #e5e7eb;
            --app-muted: #94a3b8;
            --app-border: #334155;
            --app-striped: #1f2937;
            --app-accent: #3b82f6;
            --app-accent-contrast: #ffffff;

            --bs-link-color: #93c5fd;
            --bs-link-hover-color: #bfdbfe;
            --bs-navbar-toggler-icon-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28229, 231, 235, 0.85%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        body {
            background-color: var(--app-bg);
            color: var(--app-text);
        }

        .navbar,
        .card,
        .modal-content {
            background-color: var(--app-surface);
            border-color: var(--app-border);
        }

        .navbar .nav-link,
        .navbar .navbar-brand,
        .navbar .navbar-text {
            color: var(--app-text);
        }

        .navbar .nav-link.active {
            font-weight: 600;
        }

        .text-muted,
        .form-text {
            color: var(--app-muted) !important;
        }

        .form-control,
        .form-select {
            background-color: var(--app-surface);
            border-color: var(--app-border);
            color: var(--app-text);
        }

        .form-control::placeholder {
            color: var(--app-muted);
        }

        .table {
            color: var(--app-text);
            border-color: var(--app-border);
            margin-bottom: 0;
            --bs-table-color: var(--app-text);
            --bs-table-bg: var(--app-surface);
            --bs-table-border-color: var(--app-border);
            --bs-table-striped-color: var(--app-text);
            --bs-table-striped-bg: var(--app-striped);
        }

        .table > :not(caption) > * > * {
            background-color: var(--app-surface);
            border-color: var(--app-border);
        }

        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: var(--app-striped);
        }

        .app-container {
            margin-top: 1.25rem;
        }

        .table-responsive {
            border: 1px solid var(--app-border);
            border-radius: 0.5rem;
            background-color: var(--app-surface);
        }

        .table thead th {
            color: var(--app-text);
        }

        .pagination {
            --bs-pagination-color: var(--app-text);
            --bs-pagination-bg: var(--app-surface);
            --bs-pagination-border-color: var(--app-border);
            --bs-pagination-hover-color: var(--app-text);
            --bs-pagination-hover-bg: var(--app-striped);
            --bs-pagination-hover-border-color: var(--app-border);
            --bs-pagination-focus-color: var(--app-text);
            --bs-pagination-focus-bg: var(--app-striped);
            --bs-pagination-focus-box-shadow: none;
            --bs-pagination-active-color: var(--app-accent-contrast);
            --bs-pagination-active-bg: var(--app-accent);
            --bs-pagination-active-border-color: var(--app-accent);
            --bs-pagination-disabled-color: var(--app-muted);
            --bs-pagination-disabled-bg: var(--app-surface);
            --bs-pagination-disabled-border-color: var(--app-border);
        }

        canvas {
            color: var(--app-text) !important;
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom">
    <div class="container-fluid px-3 px-md-4">
        <a class="navbar-brand" href="{{ url_for('index') }}">Filament Logs</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#appNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="appNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">Inventory</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'log_filament' %}active{% endif %}" href="{{ url_for('log_filament') }}">Log Usage</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'new_roll' %}active{% endif %}" href="{{ url_for('new_roll') }}">Add Roll</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'popular_filaments' %}active{% endif %}" href="{{ url_for('popular_filaments') }}">Popular</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'low_empty_filaments' %}active{% endif %}" href="{{ url_for('low_empty_filaments') }}">Low/Empty</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'empty_rolls' %}active{% endif %}" href="{{ url_for('empty_rolls') }}">Empty</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'favorites' %}active{% endif %}" href="{{ url_for('favorites') }}">Favorites</a></li>
            </ul>
            <div class="d-flex align-items-center gap-2">
                <span class="navbar-text small">{{ app_settings.theme|capitalize }} mode</span>
                <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm {% if request.endpoint == 'settings' %}active{% endif %}">Settings</a>
                <img src="{{ url_for('static', filename='MakerCampus_Logo.jpg') }}" alt="Logo" style="height:36px; border-radius:4px;">
            </div>
        </div>
    </div>
</nav>

<div class="container app-container pb-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% set mapped = 'danger' if category == 'error' else category %}
          {% set show_alert = true %}
          {% if app_settings.alert_mode == 'silent' %}
            {% set show_alert = false %}
          {% elif app_settings.alert_mode == 'errors_only' and mapped != 'danger' %}
            {% set show_alert = false %}
          {% endif %}

          {% if show_alert %}
          <div class="alert alert-{{ mapped if mapped in ['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'light', 'dark'] else 'info' }} alert-dismissible fade show app-alert" role="alert" data-level="{{ mapped }}">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.APP_SETTINGS = {{ app_settings|default({}, true)|tojson|safe }};

function applyChartThemeDefaults() {
    const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue("--app-text").trim();
    const chartGridColor = getComputedStyle(document.documentElement).getPropertyValue("--app-border").trim();

    if (!window.Chart || !window.Chart.defaults) {
        return false;
    }

    window.Chart.defaults.color = chartTextColor || "#111827";
    window.Chart.defaults.borderColor = chartGridColor || "#d1d5db";

    if (window.Chart.defaults.plugins && window.Chart.defaults.plugins.legend) {
        if (!window.Chart.defaults.plugins.legend.labels) {
            window.Chart.defaults.plugins.legend.labels = {};
        }
        window.Chart.defaults.plugins.legend.labels.color = chartTextColor || "#111827";
    }

    if (window.Chart.instances) {
        Object.values(window.Chart.instances).forEach((chart) => {
            try {
                chart.update();
            } catch (_) {
                // no-op
            }
        });
    }
    return true;
}

applyChartThemeDefaults();
window.addEventListener("load", applyChartThemeDefaults);

(function () {
    const settings = window.APP_SETTINGS || {};
    if (settings.alert_mode !== "browser") {
        return;
    }

    if (!("Notification" in window)) {
        return;
    }

    const alerts = Array.from(document.querySelectorAll(".app-alert"));
    if (!alerts.length) {
        return;
    }

    const notify = () => {
        alerts.forEach((alertEl) => {
            const level = alertEl.dataset.level || "info";
            const body = alertEl.textContent.trim();
            if (!body) {
                return;
            }
            try {
                new Notification(`Filament Logs: ${level}`, { body });
            } catch (_) {
                // no-op
            }
        });
    };

    if (Notification.permission === "granted") {
        notify();
        return;
    }

    if (Notification.permission === "default") {
        Notification.requestPermission()
            .then((permission) => {
                if (permission === "granted") {
                    notify();
                }
            })
            .catch(() => {
                // no-op
            });
    }
})();
</script>
{% block scripts %}{% endblock %}
</body>
</html>
