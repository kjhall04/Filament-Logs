<!DOCTYPE html>
<html lang="en" data-theme="{{ app_settings.theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Filament Logs{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-bg: #edf2f7;
            --app-surface: #ffffff;
            --app-surface-soft: #f8fafc;
            --app-text: #0f172a;
            --app-muted: #64748b;
            --app-border: #cbd5e1;
            --app-striped: #f8fafc;
            --app-hover: #edf3ff;
            --app-accent: #0ea5e9;
            --app-accent-2: #f97316;
            --app-accent-contrast: #ffffff;
            --app-gradient: linear-gradient(120deg, #0ea5e9 0%, #f97316 100%);
            --app-navbar-bg: rgba(255, 255, 255, 0.86);
            --app-bg-image:
                radial-gradient(70rem 40rem at -10% -15%, rgba(14, 165, 233, 0.2), transparent 58%),
                radial-gradient(58rem 28rem at 110% -10%, rgba(249, 115, 22, 0.16), transparent 56%),
                linear-gradient(180deg, #f8fafc 0%, #edf2f7 100%);
            --app-card-shadow: 0 10px 24px rgba(15, 23, 42, 0.09);

            --bs-body-bg: var(--app-bg);
            --bs-body-color: var(--app-text);
            --bs-secondary-color: var(--app-muted);
            --bs-emphasis-color: var(--app-text);
            --bs-border-color: var(--app-border);
            --bs-tertiary-bg: var(--app-surface);
        }

        html[data-theme="dark"] {
            --app-bg: #0b1220;
            --app-surface: #111b2e;
            --app-surface-soft: #172338;
            --app-text: #e2e8f0;
            --app-muted: #94a3b8;
            --app-border: #2d3b52;
            --app-striped: #0f1a2c;
            --app-hover: #1a2b45;
            --app-accent: #38bdf8;
            --app-accent-2: #fb923c;
            --app-accent-contrast: #ffffff;
            --app-gradient: linear-gradient(120deg, #38bdf8 0%, #fb923c 100%);
            --app-navbar-bg: rgba(10, 18, 32, 0.88);
            --app-bg-image:
                radial-gradient(70rem 42rem at -8% -18%, rgba(56, 189, 248, 0.14), transparent 58%),
                radial-gradient(56rem 30rem at 110% -10%, rgba(251, 146, 60, 0.12), transparent 54%),
                linear-gradient(180deg, #0b1220 0%, #10192c 100%);
            --app-card-shadow: 0 12px 30px rgba(0, 0, 0, 0.38);

            --bs-link-color: #7dd3fc;
            --bs-link-hover-color: #bae6fd;
            --bs-navbar-toggler-icon-bg: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28226, 232, 240, 0.88%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        body {
            background-color: var(--app-bg);
            background-image: var(--app-bg-image);
            background-attachment: fixed;
            color: var(--app-text);
            font-family: "Sora", "Segoe UI", sans-serif;
        }

        h1,
        h2,
        h3,
        .navbar-brand {
            font-family: "Space Grotesk", "Sora", "Segoe UI", sans-serif;
        }

        h1 {
            letter-spacing: -0.02em;
            font-weight: 700;
        }

        .navbar {
            background-color: var(--app-navbar-bg);
            backdrop-filter: blur(12px);
            border-color: var(--app-border);
            border-top: 0;
            border-radius: 0 0 1rem 1rem;
            margin: 0 0.75rem;
            box-shadow: var(--app-card-shadow);
        }

        .navbar .nav-link,
        .navbar .navbar-brand,
        .navbar .navbar-text {
            color: var(--app-text);
        }

        .navbar .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .navbar .nav-link {
            border-radius: 999px;
            padding: 0.35rem 0.85rem !important;
            transition: background-color 0.18s ease, color 0.18s ease, transform 0.18s ease;
        }

        .navbar .nav-link:hover {
            background-color: var(--app-surface-soft);
            transform: translateY(-1px);
        }

        .navbar .nav-link.active {
            font-weight: 600;
            color: #ffffff;
            background: var(--app-gradient);
            box-shadow: 0 6px 14px rgba(14, 165, 233, 0.33);
        }

        .text-muted,
        .form-text {
            color: var(--app-muted) !important;
        }

        .card,
        .modal-content,
        .table-responsive {
            background-color: var(--app-surface);
            border-color: var(--app-border);
            box-shadow: var(--app-card-shadow);
        }

        .card,
        .modal-content,
        .table-responsive {
            border-radius: 0.9rem;
        }

        .form-control,
        .form-select {
            background-color: var(--app-surface);
            border-color: var(--app-border);
            color: var(--app-text);
            border-radius: 0.7rem;
        }

        .form-control::placeholder {
            color: var(--app-muted);
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--app-accent);
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.2);
        }

        .btn {
            border-radius: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.01em;
            transition: transform 0.14s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--app-gradient);
            border: 0;
            color: #ffffff;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            color: #ffffff;
            box-shadow: 0 8px 16px rgba(14, 165, 233, 0.34);
        }

        .btn-success {
            background: linear-gradient(120deg, #16a34a 0%, #0ea5a4 100%);
            border: 0;
            color: #ffffff;
        }

        .btn-success:hover,
        .btn-success:focus {
            color: #ffffff;
            box-shadow: 0 8px 16px rgba(22, 163, 74, 0.3);
        }

        .btn-secondary {
            background-color: var(--app-surface-soft);
            border-color: var(--app-border);
            color: var(--app-text);
        }

        .btn-secondary:hover,
        .btn-secondary:focus {
            background-color: var(--app-striped);
            border-color: var(--app-border);
            color: var(--app-text);
        }

        .btn-outline-secondary {
            color: var(--app-text);
            border-color: var(--app-border);
        }

        .btn-outline-secondary:hover,
        .btn-outline-secondary:focus {
            color: var(--app-text);
            background-color: var(--app-surface-soft);
            border-color: var(--app-border);
        }

        .table {
            color: var(--app-text);
            border-color: var(--app-border);
            margin-bottom: 0;
            --bs-table-color: var(--app-text);
            --bs-table-bg: var(--app-surface);
            --bs-table-border-color: var(--app-border);
            --bs-table-striped-color: var(--app-text);
            --bs-table-striped-bg: var(--app-striped);
        }

        .table > :not(caption) > * > * {
            background-color: var(--app-surface);
            border-color: var(--app-border);
        }

        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: var(--app-striped);
        }

        .table tbody tr:hover > * {
            background-color: var(--app-hover);
        }

        .table thead th {
            color: var(--app-muted);
            text-transform: uppercase;
            font-size: 0.76rem;
            letter-spacing: 0.08em;
            font-weight: 700;
            background-color: var(--app-surface-soft);
        }

        .app-container {
            margin-top: 1.5rem;
        }

        .table-responsive {
            border: 1px solid var(--app-border);
        }

        .pagination {
            --bs-pagination-color: var(--app-text);
            --bs-pagination-bg: var(--app-surface);
            --bs-pagination-border-color: var(--app-border);
            --bs-pagination-hover-color: var(--app-text);
            --bs-pagination-hover-bg: var(--app-striped);
            --bs-pagination-hover-border-color: var(--app-border);
            --bs-pagination-focus-color: var(--app-text);
            --bs-pagination-focus-bg: var(--app-striped);
            --bs-pagination-focus-box-shadow: none;
            --bs-pagination-active-color: var(--app-accent-contrast);
            --bs-pagination-active-bg: var(--app-accent);
            --bs-pagination-active-border-color: var(--app-accent);
            --bs-pagination-disabled-color: var(--app-muted);
            --bs-pagination-disabled-bg: var(--app-surface);
            --bs-pagination-disabled-border-color: var(--app-border);
        }

        .alert {
            border-radius: 0.8rem;
        }

        .app-alert {
            border-left: 4px solid currentColor;
            box-shadow: var(--app-card-shadow);
        }

        .favorite-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            line-height: 1;
        }

        .favorite-star {
            font-size: 1.55rem;
            color: var(--app-muted);
            display: inline-block;
            transition: transform 0.15s ease, color 0.15s ease, text-shadow 0.15s ease;
        }

        .favorite-btn:hover .favorite-star,
        .favorite-star:hover {
            transform: scale(1.12);
        }

        .favorite-star.is-on {
            color: #fbbf24;
            text-shadow: 0 0 12px rgba(251, 191, 36, 0.34);
        }

        .favorite-star.is-off {
            color: #94a3b8;
        }

        canvas {
            color: var(--app-text) !important;
        }

        @media (max-width: 991.98px) {
            .navbar {
                margin: 0;
                border-radius: 0;
                border-left: 0;
                border-right: 0;
            }
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom">
    <div class="container-fluid px-3 px-md-4">
        <a class="navbar-brand" href="{{ url_for('index') }}">Filament Logs</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#appNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="appNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">Inventory</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'log_filament' %}active{% endif %}" href="{{ url_for('log_filament') }}">Log Usage</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'new_roll' %}active{% endif %}" href="{{ url_for('new_roll') }}">Add Roll</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'popular_filaments' %}active{% endif %}" href="{{ url_for('popular_filaments') }}">Popular</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'low_empty_filaments' %}active{% endif %}" href="{{ url_for('low_empty_filaments') }}">Low/Empty</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'empty_rolls' %}active{% endif %}" href="{{ url_for('empty_rolls') }}">Empty</a></li>
                <li class="nav-item"><a class="nav-link {% if request.endpoint == 'favorites' %}active{% endif %}" href="{{ url_for('favorites') }}">Favorites</a></li>
            </ul>
            <div class="d-flex align-items-center gap-2">
                <span class="navbar-text small">{{ app_settings.theme|capitalize }} mode</span>
                <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary btn-sm {% if request.endpoint == 'settings' %}active{% endif %}">Settings</a>
                <img src="{{ url_for('static', filename='MakerCampus_Logo.jpg') }}" alt="Logo" style="height:36px; border-radius:4px;">
            </div>
        </div>
    </div>
</nav>

<div class="container app-container pb-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {% set mapped = 'danger' if category == 'error' else category %}
          {% set show_alert = true %}
          {% if app_settings.alert_mode == 'silent' %}
            {% set show_alert = false %}
          {% elif app_settings.alert_mode == 'errors_only' and mapped != 'danger' %}
            {% set show_alert = false %}
          {% endif %}

          {% if show_alert %}
          <div class="alert alert-{{ mapped if mapped in ['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'light', 'dark'] else 'info' }} alert-dismissible fade show app-alert" role="alert" data-level="{{ mapped }}">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
window.APP_SETTINGS = {{ app_settings|default({}, true)|tojson|safe }};

function applyChartThemeDefaults() {
    const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue("--app-text").trim();
    const chartGridColor = getComputedStyle(document.documentElement).getPropertyValue("--app-border").trim();

    if (!window.Chart || !window.Chart.defaults) {
        return false;
    }

    window.Chart.defaults.color = chartTextColor || "#111827";
    window.Chart.defaults.borderColor = chartGridColor || "#d1d5db";

    if (window.Chart.defaults.plugins && window.Chart.defaults.plugins.legend) {
        if (!window.Chart.defaults.plugins.legend.labels) {
            window.Chart.defaults.plugins.legend.labels = {};
        }
        window.Chart.defaults.plugins.legend.labels.color = chartTextColor || "#111827";
    }

    if (window.Chart.instances) {
        Object.values(window.Chart.instances).forEach((chart) => {
            try {
                chart.update();
            } catch (_) {
                // no-op
            }
        });
    }
    return true;
}

applyChartThemeDefaults();
window.addEventListener("load", applyChartThemeDefaults);

(function () {
    const settings = window.APP_SETTINGS || {};
    if (settings.alert_mode !== "browser") {
        return;
    }

    if (!("Notification" in window)) {
        return;
    }

    const alerts = Array.from(document.querySelectorAll(".app-alert"));
    if (!alerts.length) {
        return;
    }

    const notify = () => {
        alerts.forEach((alertEl) => {
            const level = alertEl.dataset.level || "info";
            const body = alertEl.textContent.trim();
            if (!body) {
                return;
            }
            try {
                new Notification(`Filament Logs: ${level}`, { body });
            } catch (_) {
                // no-op
            }
        });
    };

    if (Notification.permission === "granted") {
        notify();
        return;
    }

    if (Notification.permission === "default") {
        Notification.requestPermission()
            .then((permission) => {
                if (permission === "granted") {
                    notify();
                }
            })
            .catch(() => {
                // no-op
            });
    }
})();
</script>
{% block scripts %}{% endblock %}
</body>
</html>
