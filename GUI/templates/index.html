{% extends "base.html" %}

{% block title %}Inventory | Filament Logs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Filament Inventory</h1>
    <span class="text-muted">Total rolls: {{ total }}</span>
</div>

<div class="d-flex flex-wrap gap-2 mb-3">
    <a href="{{ url_for('log_filament') }}" class="btn btn-primary">Log Filament Usage</a>
    <a href="{{ url_for('new_roll') }}" class="btn btn-success">Add New Roll</a>
    <a href="{{ url_for('popular_filaments') }}" class="btn btn-info">Most Popular</a>
    <a href="{{ url_for('low_empty_filaments') }}" class="btn btn-warning">Low/Empty</a>
    <a href="{{ url_for('empty_rolls') }}" class="btn btn-danger">Empty Rolls</a>
    <a href="{{ url_for('favorites') }}" class="btn btn-dark">Favorites</a>
</div>

<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search inventory... (type 'favorite' to filter starred)">
</div>

<div class="table-responsive">
    <table class="table table-striped" id="filamentTable">
        <thead>
            <tr>
                <th style="width: 40px;"></th>
                <th>Timestamp</th>
                <th>Barcode</th>
                <th>Brand</th>
                <th>Color</th>
                <th>Material</th>
                <th>Attribute 1</th>
                <th>Attribute 2</th>
                <th>Amount (g)</th>
                <th>Location</th>
                <th>Roll Weight (g)</th>
                <th>Times Logged Out</th>
                <th>Is Empty</th>
            </tr>
        </thead>
        <tbody>
            {% for filament in filaments %}
            <tr data-favorite="{{ 'true' if filament|length > 12 and filament[12]|string|lower == 'true' else 'false' }}">
                <td>
                    <button class="favorite-btn" data-barcode="{{ filament[1] }}" style="background:none; border:none; padding:0; cursor:pointer;">
                        {% if filament|length > 12 and filament[12]|string|lower == 'true' %}
                            <span style="color:gold; font-size:1.6rem;">&#9733;</span>
                        {% else %}
                            <span style="color:#9ca3af; font-size:1.6rem;">&#9734;</span>
                        {% endif %}
                    </button>
                </td>
                <td>{{ filament[0] if filament[0] is not none else '' }}</td>
                <td>{{ filament[1] if filament[1] is not none else '' }}</td>
                <td>{{ filament[2] if filament[2] is not none else '' }}</td>
                <td>{{ filament[3] if filament[3] is not none else '' }}</td>
                <td>{{ filament[4] if filament[4] is not none else '' }}</td>
                <td>{{ filament[5] if filament[5] is not none else '' }}</td>
                <td>{{ filament[6] if filament[6] is not none else '' }}</td>
                <td>{{ filament[7] if filament[7] is not none else '' }}</td>
                <td>{{ filament[8] if filament[8] is not none else '' }}</td>
                <td>{{ filament[9] if filament[9] is not none else '' }}</td>
                <td>{{ filament[10] if filament[10] is not none else '' }}</td>
                <td>{{ filament[11] if filament[11] is not none else '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>
<div class="text-center text-muted" id="showingInfo"></div>
{% endblock %}

{% block scripts %}
<script>
const rows = Array.from(document.querySelectorAll("#filamentTable tbody tr"));
const perPage = Math.max(1, Number((window.APP_SETTINGS && window.APP_SETTINGS.rows_per_page) || 20));
let currentPage = 1;
let filteredRows = rows;

function showPage(page) {
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / perPage));
    currentPage = Math.min(Math.max(1, page), totalPages);

    const start = (currentPage - 1) * perPage;
    const end = start + perPage;

    rows.forEach((row) => {
        row.style.display = "none";
    });

    filteredRows.slice(start, end).forEach((row) => {
        row.style.display = "";
    });

    renderPagination();
    renderShowingInfo();
}

function renderPagination() {
    const totalPages = Math.max(1, Math.ceil(filteredRows.length / perPage));
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    const prevDisabled = currentPage === 1 ? "disabled" : "";
    const nextDisabled = currentPage === totalPages ? "disabled" : "";

    pagination.innerHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" onclick="showPage(${currentPage - 1}); return false;">Previous</a></li>`;

    for (let i = 1; i <= totalPages; i += 1) {
        const active = i === currentPage ? "active" : "";
        pagination.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="showPage(${i}); return false;">${i}</a></li>`;
    }

    pagination.innerHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" onclick="showPage(${currentPage + 1}); return false;">Next</a></li>`;
}

function renderShowingInfo() {
    const info = document.getElementById("showingInfo");
    const start = (currentPage - 1) * perPage + 1;
    const end = Math.min(currentPage * perPage, filteredRows.length);

    info.textContent = `Showing ${filteredRows.length === 0 ? 0 : start}-${end} of ${filteredRows.length} entries`;
}

document.getElementById("searchInput").addEventListener("input", function () {
    const filter = this.value.trim().toLowerCase();
    filteredRows = rows.filter((row) => {
        if (filter === "favorite") {
            return row.dataset.favorite === "true";
        }

        return Array.from(row.querySelectorAll("td")).some((cell) =>
            cell.textContent.toLowerCase().includes(filter)
        );
    });

    showPage(1);
});

document.querySelectorAll(".favorite-btn").forEach((button) => {
    button.addEventListener("click", async function (event) {
        event.preventDefault();
        const barcode = this.getAttribute("data-barcode");

        try {
            const response = await fetch("{{ url_for('toggle_favorite') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ barcode }),
            });
            if (response.ok) {
                window.location.reload();
            }
        } catch (_) {
            // no-op
        }
    });
});

window.showPage = showPage;
showPage(1);
</script>
{% endblock %}
